<!-- save-as: infinitecanvas_singlefile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Infinite Canvas — Creative Workspace</title>
<meta name="description" content="InfiniteCanvas.org — secure, responsive infinite drawing canvas with autosave, versioning, and optional client-side encryption."/>
<style>
/* ---------- Windows 98/XP Classic Theme ---------- */
:root{
  --window-bg:#c0c0c0;
  --taskbar:#000080;
  --panel:#e0e0e0;
  --btn-face:#c0c0c0;
  --btn-border:#ffffff;
  --accent:#000080;
  --muted:#666;
  --max-width:1100px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Tahoma, "Segoe UI", Arial, sans-serif;background:var(--window-bg);color:#111}
.container{max-width:var(--max-width);margin:12px auto;padding:12px}
.header{background:var(--taskbar);color:white;padding:8px 12px;border:3px solid #000;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:20px;margin:0}
.nav a{color:#fff;text-decoration:none;margin:0 8px;font-weight:600}
.main{display:grid;grid-template-columns: 1fr 360px;gap:12px;margin-top:12px}
@media (max-width:980px){.main{grid-template-columns:1fr}}
.panel{background:var(--panel);border:2px solid #808080;padding:10px;border-radius:4px;box-shadow:2px 2px 0 #fff inset}
.canvas-wrap{display:flex;flex-direction:column;gap:8px;align-items:stretch}
.canvas-toolbar{display:flex;flex-wrap:wrap;gap:6px}
button, input[type="button"], input[type="submit"]{
  font-family:Tahoma; background:var(--btn-face); border:2px outset var(--btn-border);
  padding:6px 10px;border-radius:3px;cursor:pointer; font-weight:600;
}
button:active{border-style:inset}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
small.muted{color:var(--muted)}
canvas#canvas{width:100%;height:480px;border:3px solid var(--accent);background:#ffffff;touch-action:none}
.info-box{font-size:13px;color:#222;background:#f7f7f7;padding:8px;border:1px solid #ddd;border-left:4px solid var(--accent)}
.footer{background:var(--taskbar);color:white;padding:10px;margin-top:12px;text-align:center;border-top:4px solid #000}
.section-title{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.hr{height:1px;background:#9aa; margin:12px 0}
.logo-win{width:36px;height:24px;background:linear-gradient(90deg,#fff,#eee);border:1px solid #000;padding:2px;display:inline-block}
.form-row{margin-bottom:8px}
input[type="text"], input[type="email"], textarea, select {
  width:100%; padding:8px;border:2px inset #fff;background:#fff;border-radius:2px;font-size:14px
}
textarea{min-height:110px;resize:vertical}
.small{font-size:13px;color:#333}
.badge{display:inline-block;padding:4px 6px;border-radius:4px;background:#fff;border:1px solid #999;font-weight:700}
.nav-pages{margin-top:6px}
.page{display:none}
.page.active{display:block}

/* Windows style box for company details */
.company-box{border:2px solid #808080;padding:10px;background:#f0f0f0}
.team-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
@media (max-width:600px){.team-grid{grid-template-columns:1fr}}

/* Legal table */
.legal-list{list-style: none;padding-left:0;margin:0}
.legal-list li{padding:6px 0;border-bottom:1px dashed #ddd}

/* subtle focus */
:focus{outline:3px solid rgba(0,0,128,0.15);outline-offset:2px}
.status{font-weight:700;font-size:13px}
</style>
</head>
<body>
<div class="container" role="main">
  <header class="header" role="banner">
    <div style="display:flex;gap:10px;align-items:center">
      <span class="logo-win" aria-hidden="true"></span>
      <div>
        <h1 style="margin:0">InfiniteCanvas</h1>
        <div style="font-size:12px;color:#fff;opacity:0.95">Secure • Responsive • Versioned</div>
      </div>
    </div>
    <nav class="nav" role="navigation" aria-label="Main navigation">
      <span class="nav-pages">
        <a href="#" onclick="showPage('home')">Home</a>
        <a href="#" onclick="showPage('about')">About Us</a>
        <a href="#" onclick="showPage('company')">Company</a>
        <a href="#" onclick="showPage('contact')">Contact</a>
        <a href="#" onclick="showPage('legal')">Legal</a>
      </span>
    </nav>
  </header>

  <main class="main" role="main">
    <!-- Left column: canvas and pages -->
    <section>
      <div id="home" class="page active panel" aria-labelledby="home-title">
        <div class="section-title"><h2 id="home-title" style="margin:0">Infinite Canvas — Workspace</h2></div>

        <div class="canvas-wrap">
          <div class="canvas-toolbar">
            <div class="controls">
              <button id="undoBtn" title="Undo (latest)" onclick="undoCanvas()">Undo</button>
              <button id="redoBtn" title="Redo" onclick="redoCanvas()">Redo</button>
              <button onclick="clearCanvas()" title="Clear canvas (saves history)">Clear</button>
              <button id="saveBtn" onclick="manualSave()" title="Manually save now">Save</button>

              <label class="small" style="align-self:center">Brush:
                <select id="brushSize" onchange="changeBrush(this.value)">
                  <option value="2">2px</option>
                  <option value="4" selected>4px</option>
                  <option value="8">8px</option>
                  <option value="12">12px</option>
                </select>
              </label>

              <label class="small">Opacity:
                <select id="brushAlpha" onchange="changeAlpha(this.value)">
                  <option value="1">100%</option>
                  <option value="0.75">75%</option>
                  <option value="0.5">50%</option>
                </select>
              </label>

              <label class="small">Color:
                <input type="color" id="brushColor" value="#000000" onchange="changeColor(this.value)">
              </label>

            </div>

            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
              <label class="small muted">Encrypt saves:</label>
              <input id="encryptToggle" type="checkbox" aria-label="Encrypt saves"/>
              <input id="encryptPass" type="text" placeholder="passphrase (optional)" style="width:180px" />
            </div>
          </div>

          <div style="margin-top:6px;" class="panel">
            <canvas id="canvas" width="1400" height="900" aria-label="Drawing canvas"></canvas>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>
              <span class="status" id="statusLine">Ready</span>
              <small class="muted"> • Autosave every 2 minutes • History: <span id="histCount">0</span></small>
            </div>
            <div>
              <small class="muted">Last saved:</small>
              <small id="lastSaved">Never</small>
            </div>
          </div>

          <div class="hr"></div>

          <div class="info-box">
            Tips: Use touch or mouse to draw. Enable encryption to protect the canvas with a passphrase — the passphrase remains only in your browser. For production-grade secret protection, host a server-side proxy so your API key stays secret.
          </div>
        </div>
      </div>

      <!-- About -->
      <article id="about" class="page panel" aria-labelledby="about-title">
        <h2 id="about-title">About InfiniteCanvas</h2>
        <p><strong>InfiniteCanvas</strong> was created to give artists, designers, teams and educators an easy-to-use, privacy conscious drawing workspace — accessible on phones, tablets and desktops. Our design follows a classic, minimal aesthetic so tools are fast and recognizable.</p>

        <h3>Vision</h3>
        <p>To empower creative people with a secure, reliable, and fast digital canvas that puts data control in the user's hands.</p>

        <h3>What makes us legitimate</h3>
        <ul>
          <li>Transparent saving using public cloud JSON storage (JSONBin)</li>
          <li>Client-side encryption option (user-managed passphrase)</li>
          <li>Clear legal, privacy and company pages (see Legal & Company)</li>
          <li>Autosave, versioning, and undo/redo to avoid data loss</li>
        </ul>

        <h3>Core Values</h3>
        <ol>
          <li>User control and privacy</li>
          <li>Reliability and performance</li>
          <li>Simple, inclusive design</li>
        </ol>
      </article>

      <!-- Company -->
      <article id="company" class="page panel" aria-labelledby="company-title">
        <h2 id="company-title">Company</h2>
        <div class="company-box">
          <h3>InfiniteCanvas Inc.</h3>
          <p><em>Founded:</em> 2025 • <em>Headquarters:</em> Remote • <em>Type:</em> Creative tools / SaaS (early stage)</p>

          <div class="hr"></div>

          <h4>Mission</h4>
          <p>Deliver robust creative tooling that respects user privacy and scales with the user's needs.</p>

          <h4>Team</h4>
          <div class="team-grid">
            <div><strong>Founder & CEO</strong><div class="small">Vision & product</div></div>
            <div><strong>CTO</strong><div class="small">Architecture & security</div></div>
            <div><strong>Design Lead</strong><div class="small">UI/UX & accessibility</div></div>
            <div><strong>Community</strong><div class="small">Support & outreach</div></div>
          </div>

          <h4>Roadmap (high level)</h4>
          <ul>
            <li>Cross-device sync & collaboration</li>
            <li>Secure server-side storage proxy (to hide keys)</li>
            <li>Encrypted shared sessions and granular permissions</li>
            <li>Integrations with educational & team tools</li>
          </ul>

          <h4>Investors & Partnerships</h4>
          <p class="small">We are early-stage and open to partnerships with creative education platforms and cloud storage providers.</p>
        </div>
      </article>

      <!-- Contact -->
      <article id="contact" class="page panel" aria-labelledby="contact-title">
        <h2 id="contact-title">Contact Us</h2>
        <p>We welcome feedback, security reports, partnership requests and media inquiries.</p>

        <div style="display:grid;grid-template-columns:1fr 300px;gap:12px">
          <div>
            <form id="contactForm" onsubmit="submitContactForm(event)">
              <div class="form-row">
                <label class="small">Full name</label>
                <input id="contactName" type="text" required maxlength="140" />
              </div>
              <div class="form-row">
                <label class="small">Email</label>
                <input id="contactEmail" type="email" required maxlength="140" />
              </div>
              <div class="form-row">
                <label class="small">Subject</label>
                <input id="contactSubject" type="text" required maxlength="200" />
              </div>
              <div class="form-row">
                <label class="small">Message</label>
                <textarea id="contactMessage" required maxlength="2000"></textarea>
              </div>
              <div class="form-row">
                <small class="muted">We sanitize submissions and do not publish PII without consent.</small>
              </div>
              <div style="display:flex;gap:8px">
                <input type="submit" value="Send" />
                <button type="button" onclick="resetContact()">Reset</button>
                <span id="contactStatus" class="small muted"></span>
              </div>
            </form>
          </div>

          <aside class="panel">
            <h4>Contact Info</h4>
            <p class="small"><strong>Email:</strong> handedakah@gmail.com<br/>
               <strong>Address:</strong> 100 Creative Ave, Remote • Country: Global (remote-first)<br/>
               <strong>Phone:</strong> +91 8103356828 (virtual)</p>

            <div class="hr"></div>

            <h4>Security & Responsible Disclosure</h4>
            <p class="small">To report security issues, please email handedaksh@gmail.com with details and reproduction steps. We will acknowledge within 5 business days.</p>
          </aside>
        </div>
      </article>

      <!-- Legal -->
      <article id="legal" class="page panel" aria-labelledby="legal-title">
        <h2 id="legal-title">Legal & Policies</h2>

        <h3>Terms of Service — Summary</h3>
        <p class="small">By using InfiniteCanvas you agree not to upload content that violates laws or third-party rights. We are not responsible for content you save. We reserve the right to remove content that violates our policies.</p>

        <h3>Privacy Policy — Summary</h3>
        <p class="small">We store canvas data using JSONBin.io. If you enable client-side encryption, the passphrase remains local in your browser and is never sent to JSONBin. Contact info submitted through the form may be stored in the Bin for administrative purposes.</p>

        <h3>Copyright & DMCA</h3>
        <p class="small">© <strong>InfiniteCanvas</strong> — All rights reserved. If you are the copyright owner and believe content violates your rights, use our contact form to file a DMCA notice with sufficient identification.</p>

        <h3>Security & API Keys</h3>
        <p class="small">This demo uses a JSONBin API key embedded in the client. For production, do not embed master keys in a public file — use a server-side proxy. See our security page for details.</p>

        <div class="hr"></div>
        <h4>Quick links</h4>
        <ul class="legal-list">
          <li>Privacy policy (detailed)</li>
          <li>Terms of Service (detailed)</li>
          <li>Security policy</li>
          <li>DMCA policy</li>
        </ul>
      </article>
    </section>

    <!-- Right column: meta / versions / credits -->
    <aside>
      <div class="panel">
        <h3>Version & Status</h3>
        <p class="small">App version: <span class="badge">1.0.0</span></p>
        <p class="small">Autosave interval: <span id="autosaveInterval">120s</span></p>
        <p class="small">History entries: <span id="histCountSide">0</span></p>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Recent saves</h3>
        <div id="recentSaves" class="small muted">No saves yet.</div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Security Checklist</h3>
        <ul class="small">
          <li>Client-side encryption: <strong>Available</strong></li>
          <li>Data hosted: JSONBin.io (user-provided bin)</li>
          <li>API key in-page: <strong>Yes (you provided it)</strong></li>
          <li>Recommended: Use server-side key proxy for highest security</li>
        </ul>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Credits</h3>
        <p class="small">Built with plain HTML/CSS/JS. UI theme inspired by classic Windows 98/XP for familiarity.</p>
      </div>
    </aside>
  </main>

  <footer class="footer" role="contentinfo">
    <div>&copy; <span id="year"></span> InfiniteCanvas.org — All rights reserved • <small class="small">This page is a single-file demo. For a production deployment, move API keys server-side.</small></div>
  </footer>
</div>

<script>
/* ---------- Configuration (user-provided) ---------- */
/* NOTE: you provided these values — they are used directly.
   For production, host a server to avoid exposing API keys. */
const JSONBIN_BIN_ID = '68e2b14443b1c97be95b6a72';
const JSONBIN_API_KEY = '$2a$10$2tYG2Lo94Fz5p7yM/onTIuXig3E99LYF099QwCO/5zn8yzLOACQxe';
const AUTOSAVE_INTERVAL_MS = 120000; // 2 minutes

/* ---------- UI setup ---------- */
document.getElementById('year').innerText = new Date().getFullYear();
document.getElementById('autosaveInterval').innerText = (AUTOSAVE_INTERVAL_MS/1000) + 's';

/* ---------- Canvas & Tools ---------- */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: false });
let drawing=false, lastX=0, lastY=0;
let brushSize = 4, brushAlpha = 1.0, brushColor = '#000';
ctx.lineCap = 'round';
ctx.lineJoin = 'round';
ctx.lineWidth = brushSize;
ctx.strokeStyle = brushColor;
ctx.globalAlpha = brushAlpha;

// memory / history
let history = []; // dataURL stack
let redoStack = [];
const HISTORY_LIMIT = 80;
const STATUS = document.getElementById('statusLine');
const lastSavedEl = document.getElementById('lastSaved');
const recentSavesEl = document.getElementById('recentSaves');
const histCountEls = [document.getElementById('histCount'), document.getElementById('histCountSide')];

function updateHistCounters(){
  histCountEls.forEach(e => e.innerText = history.length);
}
function pushHistory(){
  try{
    if(history.length >= HISTORY_LIMIT) history.shift();
    history.push(canvas.toDataURL('image/png'));
    redoStack = [];
    updateHistCounters();
  }catch(e){
    console.warn('history push failed', e);
  }
}

// drawing helpers (mouse + touch)
function getPosFromEvent(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches && e.touches[0]) {
    return {x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top};
  } else if (e.changedTouches && e.changedTouches[0]) {
    return {x: e.changedTouches[0].clientX - rect.left, y: e.changedTouches[0].clientY - rect.top};
  } else {
    return {x: e.offsetX, y: e.offsetY};
  }
}
function startDraw(e){
  drawing = true;
  const p = getPosFromEvent(e);
  lastX = p.x; lastY = p.y;
  // begin a tiny path so that a tap still paints a dot
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  e.preventDefault();
}
function stopDraw(e){
  if(drawing) pushHistory();
  drawing = false;
}
function draw(e){
  if(!drawing) return;
  const p = getPosFromEvent(e);
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(p.x, p.y);
  ctx.strokeStyle = brushColor;
  ctx.lineWidth = brushSize;
  ctx.globalAlpha = brushAlpha;
  ctx.stroke();
  lastX = p.x; lastY = p.y;
  e.preventDefault();
}
// attach events
canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDraw);
canvas.addEventListener('mouseout', stopDraw);
canvas.addEventListener('touchstart', startDraw, {passive:false});
canvas.addEventListener('touchmove', draw, {passive:false});
canvas.addEventListener('touchend', stopDraw);

// controls
function changeBrush(v){ brushSize = Number(v); }
function changeAlpha(v){ brushAlpha = Number(v); }
function changeColor(v){ brushColor = v; }

document.getElementById('brushSize').value = brushSize;
document.getElementById('brushAlpha').value = brushAlpha;
document.getElementById('brushColor').value = brushColor;

/* ---------- Undo / Redo ---------- */
function undoCanvas(){
  if(history.length === 0) { STATUS.innerText = 'Nothing to undo'; return; }
  redoStack.push(canvas.toDataURL());
  const dataURL = history.pop();
  const img = new Image();
  img.onload = function(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); updateHistCounters();}
  img.src = dataURL;
}
function redoCanvas(){
  if(redoStack.length === 0) { STATUS.innerText = 'Nothing to redo'; return; }
  history.push(canvas.toDataURL());
  const dataURL = redoStack.pop();
  const img = new Image();
  img.onload = function(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); updateHistCounters();}
  img.src = dataURL;
}
function clearCanvas(){
  pushHistory();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  STATUS.innerText = 'Canvas cleared';
}

/* ---------- Simple client-side encryption helpers (Web Crypto) ---------- */
/* Optional: user can check 'Encrypt saves' and provide a passphrase.
   Implementation: PBKDF2 -> AES-GCM. The passphrase never leaves browser. */
async function deriveKey(passphrase, saltHex){
  const enc = new TextEncoder();
  const passKey = await crypto.subtle.importKey('raw', enc.encode(passphrase), {name:'PBKDF2'}, false, ['deriveKey']);
  const salt = hexToBytes(saltHex);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations: 250000, hash:'SHA-256'},
    passKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
}
function bytesToHex(bytes){
  return Array.from(new Uint8Array(bytes)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function hexToBytes(hex){
  const bytes = new Uint8Array(hex.length/2);
  for(let i=0;i<bytes.length;i++) bytes[i] = parseInt(hex.substr(i*2,2),16);
  return bytes;
}
async function encryptData(plainText, passphrase){
  const iv = crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV recommended for AES-GCM
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const saltHex = bytesToHex(salt);
  const key = await deriveKey(passphrase, saltHex);
  const enc = new TextEncoder();
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plainText));
  // return compound object with iv & salt as hex + ciphertext as base64
  return {
    iv: bytesToHex(iv),
    salt: saltHex,
    cipherB64: btoa(String.fromCharCode(...new Uint8Array(cipher)))
  };
}
async function decryptData(obj, passphrase){
  const {iv, salt, cipherB64} = obj;
  const key = await deriveKey(passphrase, salt);
  const cipherBytes = Uint8Array.from(atob(cipherB64), c=>c.charCodeAt(0));
  const plainBuffer = await crypto.subtle.decrypt({name:'AES-GCM', iv:hexToBytes(iv)}, key, cipherBytes);
  return new TextDecoder().decode(plainBuffer);
}

/* ---------- JSONBin integration ---------- */
const JSONBIN_BASE = 'https://api.jsonbin.io/v3/b/';
let lastSaveTime = null;
let recentSaves = [];

// rate limiting simple guard
let lastManualSaveAt = 0;
const MANUAL_SAVE_COOLDOWN_MS = 5000; // 5s guard

async function putToJsonBin(payloadObj){
  // payloadObj should be JSON-serializable
  const url = JSONBIN_BASE + JSONBIN_BIN_ID;
  const headers = {
    'Content-Type':'application/json',
    'X-Master-Key': JSONBIN_API_KEY,
    'X-Bin-Versioning': 'false' // we keep simple overwrites; we also maintain recent saves in local array
  };
  const res = await fetch(url, {method:'PUT', headers, body: JSON.stringify(payloadObj)});
  if(!res.ok) throw new Error('JSONBin PUT failed: ' + res.status + ' ' + res.statusText);
  const json = await res.json();
  return json;
}

// sanitize simple text to remove scripts or tags
function sanitizeText(s){
  return String(s).replace(/[<>]/g,'').trim();
}

/* ---------- Save / Load ---------- */
async function saveCanvasToBin({auto=false} = {}){
  // auto: boolean; encryption depends on checkbox
  try{
    // autosave guard: do not autosave if nothing changed in last 20s (simple)
    const now = Date.now();
    if(auto && lastSaveTime && (now - lastSaveTime) < 20000) {
      STATUS.innerText = 'Autosave: no recent changes';
      return;
    }

    // get data and optionally encrypt
    const dataURL = canvas.toDataURL('image/png', 0.92);
    const record = {
      timestamp: new Date().toISOString(),
      meta: { auto },
      canvasPlain: null,
      canvasEncrypted: null
    };

    const encryptToggle = document.getElementById('encryptToggle').checked;
    const pass = document.getElementById('encryptPass').value;

    if(encryptToggle){
      if(!pass || pass.length < 4){
        STATUS.innerText = 'Encryption enabled — provide a passphrase (min 4 chars)';
        return;
      }
      STATUS.innerText = (auto ? 'Autosaving (encrypted)...' : 'Saving (encrypted)...');
      const encrypted = await encryptData(dataURL, pass); // returns {iv, salt, cipherB64}
      record.canvasEncrypted = encrypted;
    } else {
      STATUS.innerText = (auto ? 'Autosaving...' : 'Saving...');
      record.canvasPlain = dataURL;
    }

    // small metadata: dimensions + brush settings
    record.meta.canvasWidth = canvas.width;
    record.meta.canvasHeight = canvas.height;
    record.meta.brush = { size: brushSize, color: brushColor, alpha: brushAlpha };

    // last-resort: do not flood JSONBin: only allow manual saves every MANUAL_SAVE_COOLDOWN_MS
    if(!auto){
      if(now - lastManualSaveAt < MANUAL_SAVE_COOLDOWN_MS){
        STATUS.innerText = 'Please wait a moment before saving again.';
        return;
      }
      lastManualSaveAt = now;
    }

    const res = await putToJsonBin(record);
    lastSaveTime = Date.now();
    lastSavedEl.innerText = new Date().toLocaleString();
    STATUS.innerText = 'Saved OK';
    // update recent saves locally
    recentSaves.unshift({time: new Date().toLocaleString(), auto, enc: !!record.canvasEncrypted});
    if(recentSaves.length > 8) recentSaves.pop();
    updateRecentSaves();

  }catch(err){
    console.error(err);
    STATUS.innerText = 'Save failed: ' + (err.message || 'network');
  }
}
async function manualSave(){ await saveCanvasToBin({auto:false}); }
async function autosaveLoop(){
  await saveCanvasToBin({auto:true});
}
setInterval(autosaveLoop, AUTOSAVE_INTERVAL_MS);

/* ---------- Load latest from JSONBin ---------- */
async function loadLatestFromBin(){
  try{
    const url = JSONBIN_BASE + JSONBIN_BIN_ID + '/latest';
    const headers = {'X-Master-Key': JSONBIN_API_KEY};
    const res = await fetch(url, {headers});
    if(!res.ok) throw new Error('Load failed: ' + res.status);
    const json = await res.json();
    const rec = json && json.record;
    if(!rec) { STATUS.innerText = 'No record found in Bin.'; return; }

    if(rec.canvasPlain){
      const img = new Image();
      img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); STATUS.innerText = 'Loaded canvas (plain)'; };
      img.src = rec.canvasPlain;
      recentSaves.unshift({time: new Date(rec.timestamp).toLocaleString(), auto: rec.meta?.auto, enc:false});
    } else if(rec.canvasEncrypted){
      // need passphrase from user to decrypt
      const encEnabled = document.getElementById('encryptToggle');
      const passField = document.getElementById('encryptPass');
      if(!passField.value){
        STATUS.innerText = 'Latest save is encrypted — enter passphrase and click "Load (Decrypt)".';
        // but leave record in recentSaves (encrypted)
        recentSaves.unshift({time: new Date(rec.timestamp).toLocaleString(), auto: rec.meta?.auto, enc:true});
      } else {
        try{
          STATUS.innerText = 'Decrypting...';
          const decoded = await decryptData(rec.canvasEncrypted, passField.value);
          const img = new Image();
          img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); STATUS.innerText = 'Loaded canvas (decrypted)'; };
          img.src = decoded;
          recentSaves.unshift({time: new Date(rec.timestamp).toLocaleString(), auto: rec.meta?.auto, enc:true});
        }catch(e){
          console.error(e);
          STATUS.innerText = 'Decrypt failed: wrong passphrase or data corrupted.';
        }
      }
    } else {
      STATUS.innerText = 'No canvas data in latest bin record.';
    }
    if(recentSaves.length>8) recentSaves = recentSaves.slice(0,8);
    updateRecentSaves();
  }catch(err){
    console.warn('Load error', err);
    // do not spam text
  }
}
async function tryLoadLatestSilently(){ await loadLatestFromBin(); }
tryLoadLatestSilently();

/* ---------- Utility UI ---------- */
function updateRecentSaves(){
  if(recentSaves.length===0){ recentSavesEl.innerText = 'No saves yet.'; return; }
  recentSavesEl.innerHTML = recentSaves.map(r => `<div>${r.time} ${r.enc?'<strong>(encrypted)</strong>':''} ${r.auto?'<em>(auto)</em>':''}</div>`).join('');
}
updateRecentSaves();

/* ---------- Contact form handling (sanitized) ---------- */
async function submitContactForm(e){
  e.preventDefault();
  const name = sanitizeText(document.getElementById('contactName').value);
  const email = sanitizeText(document.getElementById('contactEmail').value);
  const subject = sanitizeText(document.getElementById('contactSubject').value);
  const message = sanitizeText(document.getElementById('contactMessage').value);

  if(!name || !email || !message){ document.getElementById('contactStatus').innerText='Please fill required fields.'; return; }

  // store to JSONBin as a contact record (append-like by writing latest with messages array)
  try{
    // first fetch latest record, then append contact
    const fetchUrl = JSONBIN_BASE + JSONBIN_BIN_ID + '/latest';
    const fetchRes = await fetch(fetchUrl, {headers:{'X-Master-Key': JSONBIN_API_KEY}});
    if(!fetchRes.ok) throw new Error('Cannot fetch bin for contact append');
    const json = await fetchRes.json();
    const record = json.record || {};
    record.contacts = record.contacts || [];
    record.contacts.push({name,email,subject,message,timestamp:new Date().toISOString()});
    // write back
    await putToJsonBin(record);
    document.getElementById('contactStatus').innerText = 'Message sent — thank you.';
    document.getElementById('contactForm').reset();
  }catch(err){
    console.error(err);
    document.getElementById('contactStatus').innerText = 'Send failed.';
  }
}
function resetContact(){ document.getElementById('contactForm').reset(); document.getElementById('contactStatus').innerText=''; }

/* ---------- Page navigation ---------- */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ---------- Keyboard shortcuts ---------- */
window.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key === 'z') { e.preventDefault(); undoCanvas(); }
  if(e.ctrlKey && e.key === 'y') { e.preventDefault(); redoCanvas(); }
  if(e.key === 's' && (e.metaKey || e.ctrlKey)) { e.preventDefault(); manualSave(); }
});

/* ---------- Initial seed history & settings ---------- */
(function init(){
  // fill canvas white background
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  pushHistory(); // initial state
  updateHistCounters();
  // load any existing latest record (no blocking)
  setTimeout(tryLoadLatestSilently, 1000);
})();

/* ---------- Expose some functions for UI debugging (optional) ---------- */
window.saveCanvasToBin = saveCanvasToBin;
window.manualSave = manualSave;
window.loadLatestFromBin = loadLatestFromBin;

</script>
</body>
</html>
